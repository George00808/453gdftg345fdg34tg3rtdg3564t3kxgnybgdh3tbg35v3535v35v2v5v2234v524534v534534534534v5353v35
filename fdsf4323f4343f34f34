local XpireMenu = {
    ESP = {},
    ObjectOptions = {
        Sensitivity = 0.1,
        currentObject = {},
    },
    Functions = {},
    DynamicTriggers = {
        Search = {
            { "jail:jailPlayer", "ESXQalleJail" },
            { "job:rev", 'ESXRevive' },
            { "job:ESXHandcuff", 'ESXHandcuff' },
            { "job:drag", 'ESXDrag' },
            { "vangelico_robbery:rob", 'ESXVangelicoRobbery' },
            { "Tackle", "tryTackle"},
            { "InteractionMenu:Jail", 'JailSEM' },
            { "InteractionMenu:DragNear", 'DragSEM' },
        },
        Triggers = {
            ['JailSEM'] = "SEM_InteractionMenu:Jail",
            ['DragSEM'] = "SEM_InteractionMenu:DragNear",
        },
    },
    Objectlist = {},
    menus = {},
    Cache = {},
    UI = {
        GTAInput = false,
        RGB = true,
        MenuX = 0.75,
        MenuY = 0.025,
        NotificationX = 0.011,
        NotificationY = 0.3025,
        TitleHeight = 0.11,
        ButtonHeight = 0.038,
        ButtonScale = 0.325,
        ButtonFont = 0,
        MaximumOptionCount = 14,
    },
    BottomText = nil,
    Version = "1.1.0",
    ScreenWidth = 0,
    ScreenHeight = 0,
    rgb = { r = 255, g = 255, b = 255},
    optionCount = 0,
    currentMenu = nil,
}

-- Initialize screen dimensions
XpireMenu.ScreenWidth, XpireMenu.ScreenHeight = Citizen.InvokeNative(0x873C9F3104101DD3, Citizen.PointerValueInt(), Citizen.PointerValueInt())

local RuntimeTXD = CreateRuntimeTxd('XpireMenu')
local HeaderObject = CreateDui("https://i.ibb.co/7txT6BLT/Xpire-Menu-1.png", 512, 128)
_G.HeaderObject = HeaderObject
local TextureThing = GetDuiHandle(HeaderObject)
local Texture = CreateRuntimeTextureFromDuiHandle(RuntimeTXD, 'XpireMenuHeader', TextureThing)
local LogoObject = CreateDui("https://i.ibb.co/Fb4wG51c/Xpire-Menu2.png", 30, 30)
_G.LogoObject = LogoObject
local TextureThing2 = GetDuiHandle(LogoObject)
local Texture2 = CreateRuntimeTextureFromDuiHandle(RuntimeTXD, 'XpireMenuLogo', TextureThing2)

function XpireMenu.RGBRainbow(frequency)
    if XpireMenu.UI.RGB then
        local result = {}
        local curtime = GetGameTimer() / 1000
        
        result.r = math.floor(math.sin(curtime * frequency + 0) * 127 + 128)
        result.g = math.floor(math.sin(curtime * frequency + 2) * 127 + 128)
        result.b = math.floor(math.sin(curtime * frequency + 4) * 127 + 128)
    
        return result
    else
        return XpireMenu.rgb
    end
end

function XpireMenu.SetMenuProperty(id, property, value)
    if id and XpireMenu.menus[id] then
        XpireMenu.menus[id][property] = value
    end
end

function XpireMenu.IsMenuVisible(id)
    if id and XpireMenu.menus[id] then
        return XpireMenu.menus[id].visible
    else
        return false
    end
end

function XpireMenu.CloseMenu()
    local menu = XpireMenu.menus[XpireMenu.currentMenu]
    if menu then
        if menu.aboutToBeClosed then
            XpireMenu.optionCount = 0
            menu.aboutToBeClosed = false
            XpireMenu.SetMenuVisible(XpireMenu.currentMenu, false)
            PlaySoundFrontend(-1, "QUIT", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
            XpireMenu.currentMenu = nil
        else
            menu.aboutToBeClosed = true
        end
    end
end

function XpireMenu.SetMenuVisible(id, visible, holdCurrent)
    if id and XpireMenu.menus[id] then
        XpireMenu.SetMenuProperty(id, 'visible', visible)

        if not holdCurrent and XpireMenu.menus[id] then
            XpireMenu.SetMenuProperty(id, 'currentOption', 1)
        end

        if visible then
            if id ~= XpireMenu.currentMenu and XpireMenu.IsMenuVisible(XpireMenu.currentMenu) then
                XpireMenu.SetMenuProperty(XpireMenu.currentMenu, false)
            end

            XpireMenu.currentMenu = id
        end
    end
end

function GetTextWidthS(string, font, scale)
    font = font or 4
    scale = scale or 0.35
    XpireMenu.Cache[font] = XpireMenu.Cache[font] or {}
    XpireMenu.Cache[font][scale] = XpireMenu.Cache[font][scale] or {}
    if XpireMenu.Cache[font][scale][string] then 
        return XpireMenu.Cache[font][scale][string].length 
    end
    
    Citizen.InvokeNative(0x54CE8AC98E120CAB, "STRING")
    Citizen.InvokeNative(0x6C188BE134E074AA, string)
    Citizen.InvokeNative(0x66E0276CC5F6B9DA, font or 4)
    Citizen.InvokeNative(0x07C837F9A01C34C9, scale or 0.35, scale or 0.35)
    local length = Citizen.InvokeNative(0x85F061DA64ED2F67, 1, Citizen.ReturnResultAnyway(), Citizen.ResultAsFloat())

    XpireMenu.Cache[font][scale][string] = {length = length}
    return length
end

function XpireMenu.GetTextWidth(string, font, scale)
    return GetTextWidthS(string, font, scale)
end

function XpireMenu.DrawSprite(TxtDict, TxtName, x, y, width, height, heading, red, green, blue, alpha)
    Citizen.InvokeNative(0xE7FFAE5EBF23D890, TxtDict, TxtName, x, y, width, height, heading, red, green, blue, alpha)
end

function XpireMenu.DrawRect(x, y, width, height, color)
    Citizen.InvokeNative(0x3A618A217E5154F0, x, y, width, height, color.r, color.g, color.b, color.a)
end

function XpireMenu.DrawTitle()
    local menu = XpireMenu.menus[XpireMenu.currentMenu]
    if menu then
        local x = menu.x + menu.width / 2
        local y = menu.y + XpireMenu.UI.TitleHeight / 2

        XpireMenu.DrawSprite('XpireMenu', 'XpireMenuHeader', x, y, menu.width, XpireMenu.UI.TitleHeight, 0.0, XpireMenu.rgb.r, XpireMenu.rgb.g, XpireMenu.rgb.b, 255)
    end
end

function XpireMenu.DrawBottom()
    local menu = XpireMenu.menus[XpireMenu.currentMenu]

    if menu then
        local x = menu.x + menu.width / 2
        local multiplier = 1
    
        if XpireMenu.optionCount > XpireMenu.UI.MaximumOptionCount then
            multiplier = XpireMenu.UI.MaximumOptionCount
        else
            multiplier = XpireMenu.optionCount
        end

        XpireMenu.DrawRect(x, menu.y + XpireMenu.UI.TitleHeight + XpireMenu.UI.ButtonHeight / 2 + XpireMenu.UI.ButtonHeight + XpireMenu.UI.ButtonHeight * multiplier, menu.width, XpireMenu.UI.ButtonHeight, {r = 0, g = 0, b = 0, a = 255})
    
        XpireMenu.DrawRect(x, menu.y + XpireMenu.UI.TitleHeight + XpireMenu.UI.ButtonHeight + XpireMenu.UI.ButtonHeight * multiplier, menu.width, 0.001, {r = XpireMenu.rgb.r, g = XpireMenu.rgb.g, b = XpireMenu.rgb.b, a = 255})
        
        XpireMenu.DrawSprite('XpireMenu', 'XpireMenuLogo', x, menu.y + XpireMenu.UI.ButtonHeight / 2 + XpireMenu.UI.TitleHeight + XpireMenu.UI.ButtonHeight + XpireMenu.UI.ButtonHeight * multiplier, 0.02, 0.02 * XpireMenu.ScreenWidth / XpireMenu.ScreenHeight, 0.0, XpireMenu.rgb.r, XpireMenu.rgb.g, XpireMenu.rgb.b, 255)

        XpireMenu.DrawText("instant-modz.com", {menu.x + menu.width - XpireMenu.GetTextWidth("instant-modz.com"), menu.y + XpireMenu.UI.TitleHeight + XpireMenu.UI.ButtonHeight / 6 + XpireMenu.UI.ButtonHeight + XpireMenu.UI.ButtonHeight * multiplier}, {255, 255, 255, 255}, XpireMenu.UI.ButtonScale, 0, 1, 0, 0)

        XpireMenu.DrawText(menu.currentOption .. " / " ..XpireMenu.optionCount, {menu.x + 0.005, menu.y + XpireMenu.UI.TitleHeight + XpireMenu.UI.ButtonHeight / 6 + XpireMenu.UI.ButtonHeight + XpireMenu.UI.ButtonHeight * multiplier}, {255, 255, 255, 255}, XpireMenu.UI.ButtonScale, 0, 0, 0, 0)
    end
end

function XpireMenu.DrawSubTitle()
    local menu = XpireMenu.menus[XpireMenu.currentMenu]
    if menu then
        local x = menu.x + menu.width / 2
        local y = menu.y + XpireMenu.UI.TitleHeight + XpireMenu.UI.ButtonHeight / 2
        local subTitleColor = { r = 0, g = 0, b = 0, a = 240 }
        XpireMenu.DrawRect(x, y, menu.width, XpireMenu.UI.ButtonHeight, subTitleColor)
        XpireMenu.DrawRect(x, y - XpireMenu.UI.ButtonHeight / 2, menu.width, 0.001, {r = XpireMenu.rgb.r, g = XpireMenu.rgb.g, b = XpireMenu.rgb.b, a = 255})
        XpireMenu.DrawText(menu.subTitle, {menu.x + menu.width / 2, y - XpireMenu.UI.ButtonHeight / 2 + 0.005}, {255, 255, 255, 255}, XpireMenu.UI.ButtonScale, 0, 1, 0, 1)
    end
end

function XpireMenu.DrawText(text, location, colour, size, font, alignment, textentry, outline)
    x, y = table.unpack(location)
    r, g, b, a = table.unpack(colour)

    menu = XpireMenu.menus[XpireMenu.currentMenu]

    SetTextFont(font)
    SetTextProportional(1)
    SetTextScale(size, size)
    if outline then
        SetTextDropshadow(1, 0, 0, 0, 255)
        SetTextEdge(1, 0, 0, 0, 255)
        SetTextDropShadow()
        SetTextOutline()
    end
    SetTextColour(r, g, b, a)
    if alignment == 1 then
        SetTextCentre(1)
    elseif alignment == 2 then
        if menu then
            SetTextWrap(menu.x, menu.x + menu.width - 0.005)
        end
        SetTextRightJustify(true)
    elseif alignment == 3 then
        if menu then
            SetTextWrap(menu.x, menu.x + menu.width - 0.022)
        end
        SetTextRightJustify(true)
    elseif alignment == 4 then
        if menu then
            SetTextWrap(0.0, -1.0)
        end
    end
    if type(textentry) == "string" then
        AddTextEntry(textentry, text)
        SetTextEntry(textentry)
    else
        SetTextEntry("STRING")
    end
    AddTextComponentString(text)
    DrawText(x, y)
end

function XpireMenu.drawButton(text, subText, menubutton, bottomtext)
    local menu = XpireMenu.menus[XpireMenu.currentMenu]
    local x = menu.x + menu.width / 2
    local multiplier = nil

    if menu.currentOption <= menu.maxOptionCount and XpireMenu.optionCount <= menu.maxOptionCount then
        multiplier = XpireMenu.optionCount
    elseif XpireMenu.optionCount > menu.currentOption - menu.maxOptionCount and XpireMenu.optionCount <= menu.currentOption then
        multiplier = XpireMenu.optionCount - (menu.currentOption - menu.maxOptionCount)
    end

    if multiplier then
        local y = menu.y + XpireMenu.UI.TitleHeight + XpireMenu.UI.ButtonHeight + (XpireMenu.UI.ButtonHeight * multiplier) - XpireMenu.UI.ButtonHeight / 2
        local backgroundColor = nil

        if menu.currentOption == XpireMenu.optionCount then
            backgroundColor = {r = XpireMenu.rgb.r, g = XpireMenu.rgb.g, b = XpireMenu.rgb.b, a = 180}
            XpireMenu.BottomText = bottomtext
        else
            backgroundColor = menu.menuBackgroundColor
        end
        
        XpireMenu.DrawRect(x, y, menu.width, XpireMenu.UI.ButtonHeight, backgroundColor)
        XpireMenu.DrawText(text, {menu.x + 0.005, y - (XpireMenu.UI.ButtonHeight / 2) + 0.005}, {255, 255, 255, 255}, XpireMenu.UI.ButtonScale, 0, 0)
        
        if menubutton then
            XpireMenu.DrawText(">>>", {menu.width + 0.005, y - XpireMenu.UI.ButtonHeight / 2 + 0.005}, {255, 255, 255, 255}, XpireMenu.UI.ButtonScale, 0, 2)
        end

        if not HasStreamedTextureDictLoaded('commonmenu') then
            RequestStreamedTextureDict('commonmenu', true)
        end
        
        if subText == "On" then
            XpireMenu.DrawSprite('commonmenu', "shop_box_tick", XpireMenu.menus[XpireMenu.currentMenu].width + 0.005 + menu.x - 0.017, y + 0.005 - 0.0048, 0.025, 0.025 * XpireMenu.ScreenWidth / XpireMenu.ScreenHeight, 0.0, 255, 255, 255, 200)
        elseif subText == "Off" then
            XpireMenu.DrawSprite('commonmenu', "shop_box_blank", XpireMenu.menus[XpireMenu.currentMenu].width + 0.005 + menu.x - 0.017, y + 0.005 - 0.0048, 0.025, 0.025 * XpireMenu.ScreenWidth / XpireMenu.ScreenHeight, 0.0, 255, 255, 255, 200)
        elseif not menubutton and subText ~= nil then
            XpireMenu.DrawText(subText, {menu.width + 0.005, y - XpireMenu.UI.ButtonHeight / 2 + 0.005}, {255, 255, 255, 255}, XpireMenu.UI.ButtonScale, 0, 2)
        end
    end
end

function XpireMenu.DrawChanger(text, subText)
    local menu = XpireMenu.menus[XpireMenu.currentMenu]
    local x = menu.x + menu.width / 2
    local multiplier = nil

    if menu.currentOption <= menu.maxOptionCount and XpireMenu.optionCount <= menu.maxOptionCount then
        multiplier = XpireMenu.optionCount
    elseif XpireMenu.optionCount > menu.currentOption - menu.maxOptionCount and XpireMenu.optionCount <= menu.currentOption then
        multiplier = XpireMenu.optionCount - (menu.currentOption - menu.maxOptionCount)
    end

    if multiplier then
        local y = menu.y + XpireMenu.UI.TitleHeight + XpireMenu.UI.ButtonHeight + (XpireMenu.UI.ButtonHeight * multiplier) - XpireMenu.UI.ButtonHeight / 2
        local backgroundColor = nil
        local Alignment = 2

        if menu.currentOption == XpireMenu.optionCount then
            backgroundColor = {r = XpireMenu.rgb.r, g = XpireMenu.rgb.g, b = XpireMenu.rgb.b, a = 180}
            Alignment = 3
        else
            backgroundColor = menu.menuBackgroundColor
            Alignment = 2
        end

        if not HasStreamedTextureDictLoaded('commonmenu') then 
            RequestStreamedTextureDict('commonmenu', true) 
        end

        XpireMenu.DrawRect(x, y, menu.width, XpireMenu.UI.ButtonHeight, backgroundColor)
        XpireMenu.DrawText(text, {menu.x + 0.005, y - (XpireMenu.UI.ButtonHeight / 2) + 0.005}, {255, 255, 255, 255}, XpireMenu.UI.ButtonScale, 0, 0)
        XpireMenu.DrawText(subText, {menu.width + 0.005, y - XpireMenu.UI.ButtonHeight / 2 + 0.005}, {255, 255, 255, 255}, XpireMenu.UI.ButtonScale, 0, Alignment)
        
        if menu.currentOption == XpireMenu.optionCount then
            XpireMenu.DrawSprite('commonmenu', 'arrowright', XpireMenu.UI.MenuX + menu.width - 0.0075, y, 0.0205, 0.0205 * XpireMenu.ScreenWidth / XpireMenu.ScreenHeight, 0.0, 255, 255, 255, 255)
            XpireMenu.DrawSprite('commonmenu', 'arrowright', XpireMenu.UI.MenuX + menu.width - 0.0175, y, 0.0205, 0.0205 * XpireMenu.ScreenWidth / XpireMenu.ScreenHeight, 180.0, 255, 255, 255, 255)
        end
    end
end

function XpireMenu.CreateMenu(id, title, subtitle)
    XpireMenu.menus[id] = {}
    XpireMenu.menus[id].title = title
    XpireMenu.menus[id].subTitle = subtitle
    XpireMenu.menus[id].visible = false
    XpireMenu.menus[id].previousMenu = nil
    XpireMenu.menus[id].aboutToBeClosed = false
    XpireMenu.menus[id].x = 0.75
    XpireMenu.menus[id].y = 0.025
    XpireMenu.menus[id].width = 0.24
    XpireMenu.menus[id].currentOption = 1
    XpireMenu.menus[id].maxOptionCount = XpireMenu.UI.MaximumOptionCount
    XpireMenu.menus[id].titleFont = 6
    XpireMenu.menus[id].titleColor = { r = 255, g = 255, b = 255, a = 255 }
    XpireMenu.menus[id].titleBackgroundColor = { r = 255, g = 0, b = 0, a = 255 }
    XpireMenu.menus[id].titleBackgroundSprite = nil
    XpireMenu.menus[id].menuTextColor = { r = 255, g = 255, b = 255, a = 255 }
    XpireMenu.menus[id].menuSubTextColor = { r = 189, g = 189, b = 189, a = 255 }
    XpireMenu.menus[id].menuFocusTextColor = { r = 255, g = 255, b = 255, a = 255 }
    XpireMenu.menus[id].menuFocusBackgroundColor = { r = 245, g = 245, b = 245, a = 255 }
    XpireMenu.menus[id].menuBackgroundColor = { r = 0, g = 0, b = 0, a = 160 }
    XpireMenu.menus[id].subTitleBackgroundColor = { r = XpireMenu.menus[id].menuBackgroundColor.r, g = XpireMenu.menus[id].menuBackgroundColor.g, b = XpireMenu.menus[id].menuBackgroundColor.b, a = 255 }
    XpireMenu.menus[id].buttonPressedSound = { name = "SELECT", set = "HUD_FRONTEND_DEFAULT_SOUNDSET" }
end

function XpireMenu.CreateSubMenu(id, parent, subTitle)
    if XpireMenu.menus[parent] then
        XpireMenu.CreateMenu(id, XpireMenu.menus[parent].title)

        if subTitle then
            XpireMenu.SetMenuProperty(id, 'subTitle', subTitle)
        else
            XpireMenu.SetMenuProperty(id, 'subTitle', XpireMenu.menus[parent].subTitle)
        end

        XpireMenu.SetMenuProperty(id, 'previousMenu', parent)
        XpireMenu.SetMenuProperty(id, 'x', XpireMenu.menus[parent].x)
        XpireMenu.SetMenuProperty(id, 'y', XpireMenu.menus[parent].y)
        XpireMenu.SetMenuProperty(id, 'maxOptionCount', XpireMenu.menus[parent].maxOptionCount)
        XpireMenu.SetMenuProperty(id, 'titleFont', XpireMenu.menus[parent].titleFont)
        XpireMenu.SetMenuProperty(id, 'titleColor', XpireMenu.menus[parent].titleColor)
        XpireMenu.SetMenuProperty(id, 'titleBackgroundColor', XpireMenu.menus[parent].titleBackgroundColor)
        XpireMenu.SetMenuProperty(id, 'titleBackgroundSprite', XpireMenu.menus[parent].titleBackgroundSprite)
        XpireMenu.SetMenuProperty(id, 'menuTextColor', XpireMenu.menus[parent].menuTextColor)
        XpireMenu.SetMenuProperty(id, 'menuSubTextColor', XpireMenu.menus[parent].menuSubTextColor)
        XpireMenu.SetMenuProperty(id, 'menuFocusTextColor', XpireMenu.menus[parent].menuFocusTextColor)
        XpireMenu.SetMenuProperty(id, 'menuFocusBackgroundColor', XpireMenu.menus[parent].menuFocusBackgroundColor)
        XpireMenu.SetMenuProperty(id, 'menuBackgroundColor', XpireMenu.menus[parent].menuBackgroundColor)
        XpireMenu.SetMenuProperty(id, 'subTitleBackgroundColor', XpireMenu.menus[parent].subTitleBackgroundColor)
    end
end

function XpireMenu.MenuButton(text, id, bottomText)
    local menu = XpireMenu.menus[XpireMenu.currentMenu]
    if menu then
        XpireMenu.optionCount = XpireMenu.optionCount + 1
        local isCurrent = menu.currentOption == XpireMenu.optionCount

        XpireMenu.drawButton(text, nil, true, bottomText)

        if isCurrent then
            if IsDisabledControlJustPressed(0, 201) then
                PlaySoundFrontend(-1, menu.buttonPressedSound.name, menu.buttonPressedSound.set, true)
                XpireMenu.SetMenuVisible(XpireMenu.currentMenu, false)
                XpireMenu.SetMenuProperty(id, 'x', XpireMenu.UI.MenuX)
                XpireMenu.SetMenuProperty(id, 'y', XpireMenu.UI.MenuY)
                XpireMenu.SetMenuVisible(id, true, true)
                return true
            elseif IsDisabledControlJustPressed(0, 189) or IsDisabledControlJustPressed(0, 190) then
                PlaySoundFrontend(-1, "NAV_UP_DOWN", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
            end
        end

        return false
    else
        return false
    end
end

function XpireMenu.CurrentMenu()
    return XpireMenu.currentMenu
end

function XpireMenu.ValueChanger(text, index, changeamout, minmaxvalues, callback, sensitivity)
    lowestvalue, highestvalue = table.unpack(minmaxvalues)

    if index == nil then
        index = 0
    end

    local menu = XpireMenu.menus[XpireMenu.currentMenu]

    if menu then
        XpireMenu.optionCount = XpireMenu.optionCount + 1
        local retval = XpireMenu.DrawChanger(text, tostring(index))

        if menu.currentOption == XpireMenu.optionCount then
            if sensitivity then
                if IsDisabledControlPressed(0, 189) then
                    if index > lowestvalue then
                        callback(index - changeamout)
                    end
                end
                if IsDisabledControlPressed(0, 190) then
                    if index < highestvalue then
                        callback(index + changeamout)
                    end
                end
            else
                if IsDisabledControlJustPressed(0, 189) then
                    if index > lowestvalue then
                        callback(index - changeamout)
                    end
                end
                if IsDisabledControlJustPressed(0, 190) then
                    if index < highestvalue then
                        callback(index + changeamout)
                    end
                end
            end
        end

        if retval then
            return true
        end
    end
    return false
end

function XpireMenu.ComboBox(text, items, index, callback)
    local itemsCount = #items
    local selectedItem = items[index]
    local menu = XpireMenu.menus[XpireMenu.currentMenu]

    if menu then
        XpireMenu.optionCount = XpireMenu.optionCount + 1
        XpireMenu.DrawChanger(text, selectedItem)

        if menu.currentOption == XpireMenu.optionCount then
            if IsDisabledControlJustPressed(0, 189) then
                if index > 1 then
                    callback(index - 1)
                elseif index == 1 then
                    callback(itemsCount)
                end
            end
            if IsDisabledControlJustPressed(0, 190) then
                if itemsCount > index then
                    callback(index + 1)
                elseif index == itemsCount then
                    callback(1)
                end
            end
            if IsDisabledControlJustPressed(0, 201) then
                PlaySoundFrontend(-1, menu.buttonPressedSound.name, menu.buttonPressedSound.set, true)
                return true
            elseif IsDisabledControlJustPressed(0, 189) or IsDisabledControlJustPressed(0, 190) then
                PlaySoundFrontend(-1, "NAV_UP_DOWN", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
            end
        end

        return false
    else
        return false
    end
end

function XpireMenu.Button(text, subText, bottomText)
    local menu = XpireMenu.menus[XpireMenu.currentMenu]
    if menu then
        XpireMenu.optionCount = XpireMenu.optionCount + 1
        XpireMenu.drawButton(text, subText, false, bottomText)

        if menu.currentOption == XpireMenu.optionCount then
            if IsDisabledControlJustPressed(0, 201) then
                PlaySoundFrontend(-1, menu.buttonPressedSound.name, menu.buttonPressedSound.set, true)
                return true
            elseif IsDisabledControlJustPressed(0, 189) or IsDisabledControlJustPressed(0, 190) then
                PlaySoundFrontend(-1, "NAV_UP_DOWN", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
            end
        end

        return false
    else
        return false
    end
end

function XpireMenu.CheckBox(text, checked, bottomText)
    local menu = XpireMenu.menus[XpireMenu.currentMenu]
    if menu then
        XpireMenu.optionCount = XpireMenu.optionCount + 1
        local isCurrent = menu.currentOption == XpireMenu.optionCount

        XpireMenu.drawButton(text, (checked and "On" or "Off"), false, bottomText)

        if isCurrent then
            if IsDisabledControlJustPressed(0, 201) then
                PlaySoundFrontend(-1, menu.buttonPressedSound.name, menu.buttonPressedSound.set, true)
                return true
            elseif IsDisabledControlJustPressed(0, 189) or IsDisabledControlJustPressed(0, 190) then
                PlaySoundFrontend(-1, "NAV_UP_DOWN", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
            end
        end

        return false
    else
        return false
    end
end

function XpireMenu.Display()
    if XpireMenu.IsMenuVisible(XpireMenu.currentMenu) then
        DisableControlAction(0, 187, true)
        DisableControlAction(0, 188, true)
        DisableControlAction(0, 189, true)
        DisableControlAction(0, 190, true)
        DisableControlAction(0, 201, true)
        DisableControlAction(0, 202, true)
        DisableControlAction(0, 24, true)
        DisableControlAction(0, 27, true)

        local menu = XpireMenu.menus[XpireMenu.currentMenu]

        if menu.currentOption > XpireMenu.optionCount then
            XpireMenu.menus[XpireMenu.currentMenu].currentOption = XpireMenu.optionCount
        end
        
        if menu.aboutToBeClosed then
            XpireMenu.CloseMenu()
        else
            ClearAllHelpMessages()

            if XpireMenu.menus[XpireMenu.currentMenu].currentOption == nil then
                XpireMenu.menus[XpireMenu.currentMenu].currentOption = XpireMenu.optionCount
            end
            
            XpireMenu.DrawTitle()
            XpireMenu.DrawSubTitle()
            XpireMenu.DrawBottom()

            if IsDisabledControlJustReleased(0, 187) then
                PlaySoundFrontend(-1, "NAV_UP_DOWN", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
                if menu.currentOption < XpireMenu.optionCount then
                    menu.currentOption = menu.currentOption + 1
                else
                    menu.currentOption = 1
                end
            elseif IsDisabledControlJustReleased(0, 188) then
                PlaySoundFrontend(-1, "NAV_UP_DOWN", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
                if menu.currentOption > 1 then
                    menu.currentOption = menu.currentOption - 1
                else
                    menu.currentOption = XpireMenu.optionCount
                end
            elseif IsDisabledControlJustReleased(0, 202) then
                if XpireMenu.menus[menu.previousMenu] then
                    PlaySoundFrontend(-1, "BACK", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
                    XpireMenu.SetMenuVisible(XpireMenu.currentMenu, false)
                    XpireMenu.SetMenuProperty(menu.previousMenu, 'x', XpireMenu.UI.MenuX)
                    XpireMenu.SetMenuProperty(menu.previousMenu, 'y', XpireMenu.UI.MenuY)
                    XpireMenu.SetMenuVisible(menu.previousMenu, true)
                else
                    XpireMenu.CloseMenu()
                end
            end

            XpireMenu.optionCount = 0
        end
    end
end

function XpireMenu.IsMenuOpened(id)
    return XpireMenu.IsMenuVisible(id)
end

function XpireMenu.OpenMenu(id)
    if id and XpireMenu.menus[id] then
        PlaySoundFrontend(-1, "SELECT", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
        XpireMenu.SetMenuVisible(id, true)
    end
end

Citizen.CreateThread(function()
    while true do
        Citizen.Wait(0)
        XpireMenu.rgb = XpireMenu.RGBRainbow(1)
    end
end)

_G.XpireMenu = XpireMenu
return XpireMenu
